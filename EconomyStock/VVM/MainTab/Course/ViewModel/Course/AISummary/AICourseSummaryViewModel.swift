//
//  AICourseSummaryViewModel.swift
//  EconomyStock
//
//  Created by 권형일 on 12/10/24.
//

import SwiftUI
import Combine

@Observable
class AICourseSummaryViewModel {
    let type: CourseAndNewsType
    var chatbotEntranceType: ChatbotEntranceType = .main
    
    var displayedText = ""
    var baseText = ""
    var isDisplayTextEnd = false
    
    var cancellable: AnyCancellable?
    
    init(type: CourseAndNewsType) {
        self.type = type
        initBaseText()
    }
    
    private func initBaseText() {
        switch type {
            
        case .basicEconomy:
            self.baseText = "### 1장 기초 경제\n\n#### 1. 경제 주체\n우리나라 경제는 가계, 기업, 정부, 해외부문이라는 네 가지 주체로 구성돼요.\n\n#### 2. GDP(국내총생산)\nGDP는 일정 기간 동안 한 나라의 영토 안에서 생산된 모든 재화와 서비스의 총합이에요. 공식은 GDP = 소비지출(C) + 투자지출(I) + 정부지출(G) + 순수출(X-M)로 표현돼요. \n\n1) **소비**: 주로 가계에서 이루어지며, 소득이 늘어나면 소비도 늘고, 이자율이 높아지면 소비는 줄어드는 특징이 있어요. 이자율은 돈을 빌린 대가로, 돈의 가격이라고 생각하면 이해하기 쉬워요.\n\n2) **투자**: 투자는 주로 기업이 사업을 확장하거나 토지, 건물, 기계를 구입하기 위해 이루어져요. 이자율이 낮아야 기업들이 더 많은 투자를 할 수 있어요. 투자란 주식 시세차익과는 다르게 기업의 생산 활동과 관련된 경제적 지출이에요.\n\n3) **정부지출**: 정부가 상품과 서비스를 구매하는 것으로, 재난지원금이나 실업수당처럼 대가 없이 지급되는 이전지출은 포함되지 않아요. 정부지출의 재원은 세금 징수, 국채 발행, 또는 화폐 발행을 통해 마련되며, 각각 장단점이 있어요. 세금은 저항이 크고, 국채는 미래 세금 부담을 늘릴 수 있으며, 화폐 발행은 물가 상승을 초래할 수 있어요.\n\n4) **순수출**: 순수출은 수출에서 수입을 뺀 값으로 계산돼요.\n\nGDP는 생산과 지출이 같아지는 특징이 있어요. 이는 생산된 재화와 서비스가 소득으로 분배되고, 분배된 소득이 다시 소비로 이어지기 때문이에요.\n\n3.마무리\n경제학의 목표는 경제성장과 물가안정이며, 경제성장은 GDP 증가, 국민소득 증가, 소비와 투자 증가로 연결돼요."
            
            self.chatbotEntranceType = .basicEconomyCourse
            
        case .priceLevel:
            self.baseText = "### 2장 물가\n\n#### 1. 물가란?\n물가는 경제 내 재화와 서비스의 전반적인 가격 수준을 뜻해요. 쉽게 말해, 여러 상품의 가격을 중요도에 따라 평균 낸 값이에요. **특징**: 물가와 화폐 가치는 반비례해요. 예를 들어, 물가가 올라 사과 값이 1,000원에서 1,200원이 되면, 같은 돈으로 살 수 있는 사과의 양이 줄어드는 것처럼 화폐의 가치도 떨어지는 거예요. - **물가 안정**: 물가가 너무 오르거나 내리지 않도록 조절하는 걸 말해요. 적당한 물가 상승은 경제 성장에 도움 되지만, 과도한 하락(디플레이션)은 경기침체를 나타낼 수 있어요.\n\n---\n\n#### 2. 물가 변동\n\n1) **인플레이션**\n물가가 지속적으로 상승하는 현상을 말해요. - **경기 과열**로 인해 수요가 너무 많을 때 - **원자재나 임금 상승**으로 생산비가 증가할 때 발생해요.\n\n2) **디플레이션**\n물가가 지속적으로 하락하는 현상으로, 주로 경기침체와 함께 나타나요. - 물가가 떨어지면 기업의 수익이 줄어들고, 이는 고용 감소와 소비 위축으로 이어져 경제에 악영향을 미쳐요.\n\n3) **스태그플레이션**\n물가 상승과 경기침체가 동시에 발생하는 비정상적인 상황이에요. 예측이 어렵고 대처도 쉽지 않아 경제 관리에서 가장 어려운 문제 중 하나예요.\n\n---\n\n#### 3. 물가 측정 지표\n\n1) **소비자물가지수(CPI)**\n소비자가 구입하는 상품과 서비스의 가격 변동을 보여주는 지표예요. - 농산물이나 에너지 같은 변동성이 큰 항목을 제외한 **근원소비자물가지수**는 금융정책에서 많이 사용돼요.\n\n2) **생산자물가지수(PPI)**\n국내 생산자가 시장에 공급하는 상품과 서비스의 가격 변동을 나타내요. 기업이 사용하는 소비재와 원자재가 포함되지만, 수입품과 주택 임대료는 포함되지 않아요.\n\n3) **GDP 디플레이터**\n국가 전체의 경제활동과 관련된 모든 재화와 서비스의 가격 수준을 나타내요. CPI는 소비자 중심이라면, GDP 디플레이터는 소비, 투자, 수출입 등 전체를 아우른다고 보면 돼요.\n\n---\n\n4.마무리\n#### 물가와 경제성장의 조화\n물가 안정과 경제 성장을 동시에 이루는 건 쉽지 않아요. 다만, **기술 발전**으로 생산성을 높이면 물가를 안정적으로 유지하면서도 경제 성장을 이룰 수 있어요. 하지만 기술 발전은 시간이 걸리기 때문에 정부와 금융당국이 적절히 균형을 맞추는 노력이 필요해요."
            
            self.chatbotEntranceType = .priceLevelCourse
            
        case .unEmployment:
            self.baseText = "### 3장 실업\n\n#### 1. 인구의 분류\n한 나라의 인구는 총인구 아래에 생산가능인구와 그외, 생산가능인구 아래에 경제활동인구와 비경제활동인구, 경제활동인구 아래에 취업자와 실업자로 분류돼요. 생산가능인구는 대한민국에 상주하는 만 15세 이상의 인구 중 군인, 교도소 수감자 등을 제외한 인구를 말해요. 경제활동인구는 생산가능인구 중 일할 의지와 능력이 있는 사람을 의미하며, 비경제활동인구는 일할 의지나 능력이 없는 사람을 뜻해요. 취업자는 경제활동인구 중 실제로 일을 하고 있는 사람, 실업자는 경제활동인구 중 일을 하지 못하고 있는 사람을 말해요.\n\n#### 2. 고용 지표\n실업률은 경제활동인구 중 실업자가 차지하는 비율이며, 고용률은 생산가능인구 중 취업자가 차지하는 비율을 의미해요. 실업률은 체감 실업을 과소평가하는 경향이 있는데, 그 이유는 두 가지예요. 첫째, 실망노동자(구직단념자)가 통계에서 제외되기 때문이에요. 실망노동자는 구직을 포기한 사람으로 비경제활동인구로 분류돼 실업률에 포함되지 않아요. 둘째, 비자발적 시간제 근로자가 존재하기 때문이에요. 주당 1시간 이상만 일하면 취업자로 분류되기 때문에 비정규직이나 시간제 근로자도 취업자로 간주돼요. 고용 지표는 고용이 소비를 좌우하기 때문에 중요해요. 실업이 줄어들고 일하는 사람이 많아지면 소비도 자연스럽게 증가하겠죠?\n\n#### 3. 임금\n임금은 노동의 대가로, 근로자에게는 소득의 원천이 되고 기업에게는 생산비용이 돼요. 임금이 하락하면 국민들의 소비지출이 줄어들고, 반대로 임금이 과도하게 상승하면 물가 상승과 기업의 고용 감소로 실업이 증가할 수 있어요. 따라서 적절한 임금 수준을 유지하는 것이 중요해요. 현실에서는 효율임금과 최저임금제 같은 제도로 인해 임금이 최적 수준보다 높게 결정되는 경우가 있어요. 효율임금이론은 노동자들에게 더 높은 임금을 지급해 동기를 부여하고, 이직률을 낮춰 채용 비용을 줄이는 데 기여해요.\n\n#### 4. 마무리\n고용은 사람들의 소득 수준과 소비에 직접적인 영향을 미치기 때문에 적절한 고용 수준을 유지하는 것이 매우 중요해요. 이런 이유로 고용 지표는 한 나라 경제 상황을 알려주는 중요한 척도 중 하나로 여겨져요."
            
            self.chatbotEntranceType = .unEmploymentCourse
            
        case .moneyAndFinance:
            self.baseText = "### 4장 화폐와 금융\n\n#### 1. 통화\n화폐는 경제에서 거래에 사용되는 지불 수단을 뜻하며, 통화는 현재 유통되고 있는 화폐를 의미해요. 예를 들어, 우리가 사용하는 지폐는 화폐이면서 통화이지만, 조선시대의 상평통보는 화폐이지만 통화는 아니에요. 통화량은 경제 내에서 유통되는 화폐의 양을 의미하며, 물가에 직접적인 영향을 주는 중요한 경제 변수 중 하나예요. 통화량이 많아지면 화폐 가치가 하락하고 물가는 상승해요. 짐바브웨처럼 정부가 무분별하게 화폐를 발행하면 화폐의 가치가 급격히 떨어지고 물가가 폭등하는 상황이 발생할 수 있어요. 이자율은 돈을 빌린 대가로, 돈의 가격이라고 이해하면 쉬워요. 통화량이 증가하면 돈의 가치가 낮아지고 이자율이 하락하는 경향이 있어요.\n\n#### 2. 통화지표\n통화지표는 통화량을 측정하는 기준으로, M1과 M2가 대표적이에요. M1은 현금과 요구불예금처럼 빠르게 현금화할 수 있는 화폐로 구성돼요. M2는 M1에 더해 현금화가 다소 어려운 정기예금 등도 포함한 더 넓은 범위의 통화를 나타내요.\n\n#### 3. 중앙은행의 역할\n중앙은행은 화폐 발행과 통화량 조절을 담당하는 은행이에요. 우리나라 중앙은행은 한국은행이며, 미국의 중앙은행은 연방준비제도(Fed)예요. 중앙은행은 화폐 발행과 통화정책 집행, 시중은행 및 정부 대상 은행업무 수행, 외환 관리 등 다양한 역할을 해요. 외환 관리는 환율 안정과 국제수지 불균형 조정을 포함하며, 국제수지는 경상수지와 자본수지의 합으로 구성돼요.\n\n#### 4. 화폐의 공급\n중앙은행은 경제 내 통화량을 조절하기 위해 화폐를 공급해요. 화폐 공급은 정부와 시중은행, 해외 시장 등 다양한 경로를 통해 이루어져요. 통화량이 많아지면 물가가 상승하고, 적어지면 경기침체를 유발할 수 있기 때문에 적절한 수준으로 유지하는 것이 중요해요.\n\n#### 5. 중앙은행의 통화정책 수단\n중앙은행은 채권 매매, 지준율 조정, 재할인율 정책 등을 통해 통화량과 이자율을 조정해요. 채권을 매입하면 통화량이 늘어나고, 매각하면 줄어들어요. 지준율을 올리면 시중은행의 대출 여력이 줄어 통화량이 감소하고, 재할인율을 조정해 시중은행의 자금 조달 비용을 변화시킬 수 있어요. 또한, 기준금리는 금리 체계의 기준으로 작용하며, 중앙은행은 기준금리 변동을 통해 경제 전반에 영향을 미쳐요. 기준금리가 인상되면 소비와 투자가 줄어들고 자산 가격이 하락하지만, 물가를 안정시킬 수 있어요.\n\n#### 6. 마무리\n통화량과 이자율은 경제에 큰 영향을 미치기 때문에 중앙은행은 신중하게 이를 조정해야 해요. 또한, 중앙은행이 정부로부터 독립성을 유지하는 것도 경제의 안정성을 위해 매우 중요해요."
            
            self.chatbotEntranceType = .moneyAndFinanceCourse
            
        case .exchangeRateAndBalanceOfPayment:
            self.baseText = "### 5장 환율과 국제수지\n\n#### 1. 환율의 개념\n환율은 자국 통화와 외국 통화가 교환되는 비율을 의미해요. 예를 들어, 1달러가 1400원이라면 이는 1달러를 얻기 위해 1400원을 지불해야 한다는 뜻이에요. 환율은 국가 간 무역에서 중요한 역할을 해요.\n\n#### 2. 환율 변동의 효과\n환율은 실시간으로 변동하며, 상승하거나 하락할 때 각각 다른 경제적 영향을 미쳐요. 1) **환율 상승**: 환율이 상승하면 외국 통화를 얻기 위해 더 많은 원화를 지불해야 하므로 원화 가치는 하락하고 달러 가치는 상승해요. 이 경우 수출업자는 환율 상승 전보다 동일한 상품을 더 저렴하게 수출할 수 있어 수출이 증가하지만, 수입업자는 더 비싼 비용으로 외국 상품을 들여와야 하므로 수입이 감소해요. 따라서 순수출이 증가하게 돼요. 2) **환율 하락**: 환율이 하락하면 외국 통화를 얻기 위해 더 적은 원화를 지불하면 되므로 원화 가치는 상승하고 달러 가치는 하락해요. 이 경우 수출업자는 상품 가격이 상대적으로 비싸져 수출이 감소하고, 수입업자는 외국 상품을 더 저렴하게 들여올 수 있어 수입이 증가해요. 결과적으로 순수출은 감소하게 돼요.\n\n#### 3. 국제수지\n국제수지는 한 나라가 일정 기간 동안 다른 나라와 거래한 모든 것을 집계한 계정으로, 경상수지와 자본수지로 나뉘어요. 1) **경상수지**: 상품과 서비스의 이동을 나타내며, 수출이 많아지면 경상수지가 개선되고, 수출이 줄어들면 악화돼요. 2) **자본수지**: 자본의 이동을 나타내며, 국내 이자율이 해외보다 높으면 자본이 유입되고 자본수지가 개선되지만, 반대의 경우 자본이 유출되어 자본수지가 악화돼요. 이러한 이유로 우리나라의 기준금리는 미국의 기준금리와 밀접하게 연동되는 경향이 있어요.\n\n#### 4. 마무리\n환율은 지나치게 높거나 낮은 것이 모두 좋지 않아요. 높은 환율은 수출 증가를 도울 수 있지만, 원자재 구입 비용 상승으로 기업에 부담을 줄 수 있고, 낮은 환율은 수입을 늘리지만 수출 경쟁력을 약화시킬 수 있어요. 국제 무역이 활발한 현대 경제에서는 환율과 국제수지를 적정 수준으로 유지하는 것이 매우 중요해요."
            
            self.chatbotEntranceType = .exchangeRateAndBalanceOfPaymentCourse
        }
    }
    
    func startStreamingText() {
        let sentences = self.baseText.components(separatedBy: ". ") // 문장을 기준으로 분리
        var index = 0

        self.cancellable = Timer.publish(every: 0.3, on: .main, in: .common) // 문장 단위로 간격 증가
            .autoconnect()
            .sink { _ in
                if index < sentences.count {
                    let sentence = sentences[index]
                    
                    DispatchQueue.main.async {
                        withAnimation(.smooth(duration: 1.0)) {
                            self.displayedText.append(sentence)
                            self.displayedText.append(". ")
                        }
                    }
                    
                    index += 1
                } else {
                    self.cancellable?.cancel()
                    
                    DispatchQueue.main.async {
                        withAnimation(.smooth(duration: 1.0)) {
                            self.isDisplayTextEnd = true
                        }
                    }
                }
            }
    }
}
